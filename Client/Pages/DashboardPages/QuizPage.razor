@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using studbud.Shared.Models
@using studbud.Client.Widgets
@inject NavigationManager navigationManager
@inject IDialogService Dialog
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@implements IAsyncDisposable

<!-- Main Chat Grid (Set a fixed height for the remaining area) -->
<MudGrid Style="height:100%;">
    <!-- Adjust 180px based on exact height of header and desired spacing -->
    <MudItem xs="12" md="2" Style="height:100%;">
        <!-- Page Header (Moved out of the grid for cleaner layout) -->
        <MudText Typo="Typo.h5" Class="mt-4 mb-2" Style="font-weight:bold;">You</MudText>
        <MudStack Row="true" Class="mb-4">
            <MudText Typo="Typo.subtitle1" Class="align-self-center">@current_user?.username</MudText>
        </MudStack>
        <!-- This inner container must use 100% height and flex column layout -->
        <div class="d-flex flex-column" style="height: 100%;">

            <!-- Top Section: Contacts List (flex-grow-1 pushes bottom card down) -->
            <div class="flex-grow-1 overflow-y-auto pr-2">
                <MudText Typo="Typo.h6" Class="mb-2" Style="font-weight:bold;">My Quizzes</MudText>

                @foreach (var q in quizzes)
                {

                    <MudCard Class="@(q.id == quiz?.id ? "mb-2 elevation-4" : "mb-2 elevation-0 transparent-card")" Style="border-radius:12px">
                        <MudButton Variant="Variant.Text"
                                    Color="@(q.id == quiz?.id ? Color.Primary : Color.Default)"
                                    OnClick="@(()=> {editing = true; LoadQuiz(q.id);})"
                                    Style="width:100%; text-align:left; margin-bottom:8px; align-items:center; justify-content:flex-start; justify-items:center; align-content:center;">
                            @q.name
                        </MudButton>
                    </MudCard>
                }
            </div>
            <!-- End of Contacts List -->
            <!-- Bottom Section: This will now be pinned to the bottom -->
            <MudCard Class="mt-3 pa-2 elevation-4" Style="border-radius:15px">
                <MudText Typo="Typo.body2" Class="mb-3">Chat with friends and Classmates</MudText>

                <MudSpacer></MudSpacer>

                <br />
                <MudStack Row="true">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Style="border-radius:15px" Size="Size.Small" OnClick="OnCreateQuiz" FullWidth="true">New Quiz</MudButton>
                    <MudIconButton Icon="@Icons.Material.Filled.Search" Variant="Variant.Outlined" Color="Color.Warning" Size="Size.Small" OnClick="OnFindQuiz"/>
                </MudStack>
            </MudCard>
            <!-- End of Bottom Section -->

        </div>
    </MudItem>

    <MudItem xs="12" md="10">
        @if (quiz is not null) {
            if (editing) {
                <CreateQuiz quiz="@quiz"/>
            }else {
                <AnswerQuiz quiz="@quiz"/>
            }
            <!-- <ClassView clss="@clss"/> -->
        }else{
            <MudText Typo="Typo.h6" Class="mb-2">
                Select a quiz
            </MudText>      
        }
    </MudItem>
</MudGrid>



@code {
    [Parameter]
    public Action<Quiz?, bool> OnQuizChanged {get; set;} = (x, y) => {};
    [Parameter]
    public bool editing {get; set;} = false;
    [Parameter]
    public Quiz? quiz {get; set;}
    private HubConnection? hub;
    private List<Quiz> quizzes = new();
    private User? current_user;


    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        hub = hubService.GetHubConnection().Build();
        await hub.StartAsync();
    }

    private async Task LoadQuiz(string quizId, bool bypass = false) {
        if (quizId == quiz?.id && !bypass) {
            quiz = null;
            OnQuizChanged(null, false);
            return;
        }
        quiz = await hub!.InvokeAsync<Quiz>(nameof(IAppHubServer.GetQuiz), quizId);
        OnQuizChanged(quiz, editing);
        StateHasChanged();
    }

    private async Task OnCreateQuiz()
    {
        quiz = await hub!.InvokeAsync<Quiz>(nameof(IAppHubServer.CreateQuiz), new Quiz {name = "New Quiz", code = new Random().Next(999999).ToString(),description = "",userId = current_user.id});
        quizzes.Add(quiz);
        editing = true;
    }

    private Task OnFindQuiz()
    {
        return Dialog.ShowAsync<SearchQuizDialog>("", new DialogParameters() {
            ["OnQuizOpened"] = (Quiz? q) => {
                if (q is not null) {
                    quiz = q;
                    editing = false;
                }
                StateHasChanged();
            }
        },new DialogOptions()
        {

            CloseOnEscapeKey = true 
        });

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (current_user is null) {
            current_user = await sessionStorage.GetItemAsync<User>("user");
            quizzes = await hub.InvokeAsync<List<Quiz>>(nameof(IAppHubServer.GetQuizzesFromUser), current_user.id);

            if (quiz is not null) {
                await LoadQuiz(quiz.id, true);
            } else if (editing) {
                await OnCreateQuiz();
            }
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hub is not null) {
            await hub.DisposeAsync();
        }
    }
}