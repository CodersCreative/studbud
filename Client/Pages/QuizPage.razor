@page "/quiz/{quizId?}"
@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using System.Linq
@using studbud.Shared.Models
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@inject NavigationManager navigationManager
@implements IAsyncDisposable

<PageTitle>Quiz</PageTitle>

<MudLayout>
	<MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Inherit" Edge="Edge.Start"  OnClick="OnBack"/>
        <MudText Typo="Typo.h6">@(quiz?.name ?? "Create A Quiz!")</MudText>
        <MudSpacer />
	</MudAppBar>
    <MudMainContent Class="pt-16 px-16">
        @if (quizId is null && quiz is not null) {
            <MudTextField AutoGrow Lines="6" Label="Quiz name" @bind-Value="quiz.name" />
            <MudText Typo="Typo.h6">Questions</MudText>
            <div style="display : flex; flex-wrap : nowrap;">
                <MudPagination Variant="Variant.Outlined" Count="@(questions.Count-1)" @bind-Selected="@editing" />
                <MudButton OnClick="AddDraftQuestion" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Add</MudButton>
            </div>
            if (questions.Count > editing) {
                <div><b>@questions[editing].text</b></div>
                <MudText Typo="Typo.h6">Answers</MudText>
                <div>
                    @for (var i = 0; i < questions[editing].answers?.Count; i++)
                    {
                        <MudPaper Class="pa-2 ma-2">
                            <MudTextField AutoGrow Lines="6" Label="Quiz name" @bind-Value="questions[editing].answers[i].text" />
                            <MudCheckBox @bind-Value="questions[editing].answers[i].isCorrect"></MudCheckBox>
                        </MudPaper>
                    }
                </div>
            }
        } else if (quiz is not null){
        }
    </MudMainContent>
</MudLayout>

@code {
    [Parameter]
    public string? quizId { get; set; }

    private HubConnection? hub;
    private Quiz? quiz;
    private List<Question> questions = new();
    private List<QuizSubmission> submissions = new();
    private User? current_user;
    private bool isOwner = false;
    private int editing = 0;
    private List<int?> selectedAnswers = new();

    private void OnBack() {
        navigationManager.NavigateTo("/dash");
    }

    protected override async Task OnInitializedAsync()
    {
        hub = hubService.GetHubConnection().Build();
        await hub.StartAsync();
        current_user = await sessionStorage.GetItemAsync<User>("user");
        if (quizId is null)
        {
            isOwner = true;
            if (quiz is null) {
                quiz = new Quiz();
                questions = [new Question()];
                StateHasChanged();
            }
        }
        else 
        {
            quiz = await hub.InvokeAsync<Quiz>(nameof(IAppHubServer.GetQuiz), quizId);
            questions = await hub.InvokeAsync<List<Question>>(nameof(IAppHubServer.GetQuestions), quizId);
            var subs = await hub.InvokeAsync<List<QuizSubmission>>(nameof(IAppHubServer.GetQuizSubmissions), quizId);
            submissions = subs ?? new List<QuizSubmission>();
            selectedAnswers = Enumerable.Range(0, questions.Count).Select(_ => (int?)null).ToList();
            isOwner = false;
            if (quiz is not null && current_user is not null)
            {
                isOwner = quiz.userId == current_user.id;
            }
        }
    }

    private void SetAnswer(int qIndex, int answerIndex)
    {
        if (selectedAnswers.Count <= qIndex)
        {
            for (int i = selectedAnswers.Count; i <= qIndex; i++) selectedAnswers.Add(null);
        }
        selectedAnswers[qIndex] = answerIndex;
        StateHasChanged();
    }

    private void AddDraftQuestion()
    {
        var q = new Question { text = "", answers = []};
        questions.Add(q);
        editing += 1;
        StateHasChanged();
    }

    private void RemoveDraftQuestion(Question q)
    {
        questions.Remove(q);
    }

    private async Task CreateQuiz()
    {
        if (hub is null) return;
        var qz = new Quiz { name = quiz.name, userId = current_user?.id };
        var res = await hub.InvokeAsync<Quiz>(nameof(IAppHubServer.CreateQuiz), qz);
        if (res is null) return;
        foreach (var q in questions)
        {
            q.quizId = res.id;
            await hub.InvokeAsync<Question>(nameof(IAppHubServer.CreateQuestion), q);
        }
        navigationManager.NavigateTo($"/quiz/{res.id}");
    }

    private async Task SubmitQuizAnswers()
    {
        if (hub is null || quiz is null || current_user is null) return;
        var subs = await hub.InvokeAsync<List<QuizSubmission>>(nameof(IAppHubServer.GetQuizSubmissions), quiz.id);
        var existing = subs?.FirstOrDefault(s => s.userId == current_user.id);
        if (selectedAnswers.Count < questions.Count)
        {
            for (int i = selectedAnswers.Count; i < questions.Count; i++) selectedAnswers.Add(null);
        }
        var sub = new QuizSubmission { id = existing?.id, quizId = quiz.id, userId = current_user.id, answers = selectedAnswers, date = DateTime.Now };
        var saved = await hub.InvokeAsync<QuizSubmission>(nameof(IAppHubServer.SubmitQuiz), sub);
        submissions = await hub.InvokeAsync<List<QuizSubmission>>(nameof(IAppHubServer.GetQuizSubmissions), quiz.id);
    }

    public async ValueTask DisposeAsync()
    {
        if (hub is not null) await hub.DisposeAsync();
    }
}
