@page "/dash"
@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using studbud.Shared
@using studbud.Shared.Models
@inject NavigationManager navigationManager
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@implements IAsyncDisposable


<PageTitle>Dashboard</PageTitle>

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="ToggleLeftDrawer" />
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Inherit" Edge="Edge.Start" OnClick="OnAdd" />
    </MudAppBar>
    <MudDrawer Open="@left_open" Elevation="1">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6">Acascendia</MudText>
        </MudDrawerHeader>
        <MudStack>
            @foreach (var c in chats) {
                <MudButton Variant="Variant.Filled" Color="Color.Surface" OnClick="() => {OpenChat(c);}">
                    <MudText Typo="Typo.h6" Align="Align.Center">@c.name</MudText>
                </MudButton>
            }
        </MudStack>
    </MudDrawer>
    <MudMainContent Class="pt-16 px-16">
        @if (page == Page.Classes) {
            <MudGrid>
                <MudItem xs="12">
                    <MudGrid Justify="Justify.SpaceBetween">
                        @foreach (var c in classes) {   
                            <MudItem xs="3">
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="() => {OpenClass(c);}" Class="d-flex flex-column align-center justify-center mud-width-full py-8">
                                    <MudText Typo="Typo.h6" Align="Align.Center">@c.name</MudText>
                                </MudButton>
                            </MudItem>
                        }
                    </MudGrid>
                </MudItem>
            </MudGrid>
        }else {
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                <MudTabPanel Text="Classes">
                    <MudText Typo="Typo.h6">Join</MudText>
                    <MudTextField T="string" Label="Code" @ref="codeField" />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" style="margin: 20px 0;" OnClick="OnJoinClass">Join</MudButton>
                    <MudText Typo="Typo.h6">Create</MudText>
                    <MudTextField T="string" Label="Name" @ref="nameField" />
                    <div style="display : flex; flex-wrap : nowrap;">
                        <MudTextField T="string" Label="Add Student" @ref="userField" />
                        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Inherit" Edge="Edge.Start" OnClick="OnAddUser"/>
                    </div>
                    <MudStack>
                        @foreach (var u in users) {   
                            <MudPaper style="display : flex; flex-wrap : nowrap; padding: 10px; margin: 10px 0 0 0; vertical-align: middle;">
                                <MudText Typo="Typo.h6" style="text-align: center; vertical-align: middle;">@u.username</MudText>
                                <MudSpacer></MudSpacer>
                                <MudIconButton Icon="@Icons.Material.Filled.Remove" OnClick="() => {OnRemoveUser(u);}" Color="Color.Inherit" Edge="Edge.Start" style="vertical-align: middle;"/>
                            </MudPaper>
                        }
                    </MudStack>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" style="margin: 20px 0;" OnClick="OnCreateClass">Create</MudButton>
                </MudTabPanel>
                <MudTabPanel Text="Chats">
                    <MudText Typo="Typo.h6">Create</MudText>
                    @if (users.Count > 2) {
                        <MudTextField T="string" Label="Name" @ref="nameField" />
                    }
                    <div style="display : flex; flex-wrap : nowrap;">
                        <MudTextField T="string" Label="Add User" @ref="userField" />
                        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Inherit" Edge="Edge.Start" OnClick="OnAddUser"/>
                    </div>
                    <MudStack>
                        @foreach (var u in users) {   
                            <MudPaper style="display : flex; flex-wrap : nowrap; padding: 10px; margin: 10px 0 0 0; vertical-align: middle;">
                                <MudText Typo="Typo.h6" style="text-align: center; vertical-align: middle;">@u.username</MudText>
                                <MudSpacer></MudSpacer>
                                <MudIconButton Icon="@Icons.Material.Filled.Remove" OnClick="() => {OnRemoveUser(u);}" Color="Color.Inherit" Edge="Edge.Start" style="vertical-align: middle;"/>
                            </MudPaper>
                        }
                    </MudStack>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" style="margin: 20px 0;" OnClick="OnCreateChat">Create</MudButton>
                </MudTabPanel>
            </MudTabs>

            

        }
    </MudMainContent>
</MudLayout>



@code {
    private List<Class> classes = [];
    private List<Chat> chats = [];
    private bool left_open = false;
    private Page page = Page.Classes;
    private HubConnection? hub;
    private User current_user;
    List<User> users = [];
    MudTextField<string> codeField;
    MudTextField<string> nameField;
    MudTextField<string> userField;

    enum Page {
        Classes,
        Add,
    }

    private void ToggleLeftDrawer()
    {
        left_open = !left_open;
    }

    private void OnAdd()
    {
        if (page == Page.Classes) {
            page = Page.Add;
        }else {
            page = Page.Classes;
        }
    }
    private async Task OnAddUser()
    {
        if (userField.Value.Trim() == current_user.username || userField.Value.Trim().Length <= 0 || users.Find((x) => {return x.username == userField.Value;}) is not null) {
            await userField.Clear();
            return;
        }

        var usr = await hub.InvokeAsync<User>(nameof(IAppHubServer.GetUserFromUsername), userField.Value.Trim());
        users.Add(usr);
        StateHasChanged();
    }

    private async Task OnJoinClass()
    {
        var clss = await hub.InvokeAsync<Class?>(nameof(IAppHubServer.JoinClass), current_user.id, codeField.Value.ToString());

        if (clss is not null ) {
            classes.Add(clss);
        }
        await ResetData();
    }

    private async Task OnCreateClass()
    {
        var us = users.Select((x) => x.id!).ToList()!;
        us.Add(current_user.id);

        var clss = await hub.InvokeAsync<Class>(nameof(IAppHubServer.CreateClass), new Class {
            name = nameField.Value,
            code = new Random().Next(999999).ToString(),
            teacherIds = [current_user.id],
            userIds = us,
        });

        classes.Add(clss);
        await ResetData();
    }

    private async Task OpenChat(Chat chat)
    {
        navigationManager.NavigateTo($"/chat/{chat.id}");
    }

    private async Task OpenClass(Class clss)
    {
        navigationManager.NavigateTo($"/class/{clss.id}");
    }

    private async Task OnCreateChat()
    {
        if (users.Count <= 0 ) {
            return;
        }
        var us = users.Select((x) => x.id!).ToList()!;
        us.Add(current_user.id);

        var chat = await hub.InvokeAsync<Chat>(nameof(IAppHubServer.CreateChat), new Chat {
            name = nameField.Value,
            userIds = us,
        });

        chats.Add(chat);
        await ResetData();
    }

    private void OnRemoveUser(User user)
    {
        users.Remove(user);
    }

    private async Task ResetData()
    { 
        await codeField.Clear();
        await nameField.Clear();
        await userField.Clear();
        users.Clear();
        StateHasChanged();
    }

    private async Task InitData() {
        classes = await hub.InvokeAsync<List<Class>>(nameof(IAppHubServer.GetClassesFromUser), current_user.id);
        chats = await hub.InvokeAsync<List<Chat>>(nameof(IAppHubServer.GetChatsFromUser), current_user.id);
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        
        hub = hubService.GetHubConnection().Build();
        await hub.StartAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (current_user is null || classes is null) {
            current_user = await sessionStorage.GetItemAsync<User>("user");
            await InitData();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hub is not null) {
            await hub.DisposeAsync();
        }
    }
}
