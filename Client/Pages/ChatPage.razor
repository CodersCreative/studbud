@page "/chat/{chatId}"
@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using studbud.Shared
@using studbud.Shared.Models
@using System.Text.RegularExpressions
@inject NavigationManager navigationManager
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@implements IAsyncDisposable

<PageTitle>Chat</PageTitle>

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Inherit" Edge="Edge.Start"  OnClick="OnBack"/>
        <MudText Typo="Typo.h6">@(chat?.name ?? "Loading...")</MudText>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.PersonAdd" Color="Color.Inherit" Edge="Edge.End" OnClick="()=> showAddUserPanel = !showAddUserPanel" />
        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Inherit" Edge="Edge.End" OnClick="()=> showRenamePanel = !showRenamePanel" />
    </MudAppBar>
    @if (showAddUserPanel)
    {
        <div style="padding:8px 16px;">
            <MudPaper Class="pa-2" Style="display:flex; gap:8px; align-items:center;">
                <MudTextField Placeholder="username" @bind-Value="addUsername" />
                <MudButton OnClick="AddUser">Add</MudButton>
                <MudButton Variant="Variant.Text" OnClick="(()=> showAddUserPanel = false)">Cancel</MudButton>
            </MudPaper>
        </div>
    }
    @if (showRenamePanel)
    {
        <div style="padding:8px 16px;">
            <MudPaper Class="pa-2" Style="display:flex; gap:8px; align-items:center;">
                <MudTextField Placeholder="Chat name" @bind-Value="newChatName" />
                <MudButton OnClick="RenameChat">Save</MudButton>
                <MudButton Variant="Variant.Text" OnClick="(()=> showRenamePanel = false)">Cancel</MudButton>
            </MudPaper>
        </div>
    }
    <MudMainContent Class="pt-16 px-16">
        <div>
            @{
                var orderedMessages = messages
                    .OrderBy(m => m.date)
                    .ToList();


                if (orderedMessages.Count > 0) {
                    List<List<Message>> orderedGroups = [[orderedMessages[0]]];

                    foreach (var message in orderedMessages.Skip(1)) {
                        if (orderedGroups.Last().First().userId == message.userId) {
                            orderedGroups.Last().Add(message);
                        }else {
                            orderedGroups.Add([message]);
                        }
                    }

                    for (int i = 0; i < orderedGroups.Count; i++)
                    {
                        var group = orderedGroups[i];
                        var frst = group.First().userId;
                        var usrText = frst is null ? "Loading...." : GetUserText(frst);
                        var position = usrText == "You" ? ChatBubblePosition.End : ChatBubblePosition.Start;

                        <MudChat ChatPosition="@position">
                            <MudChatHeader Name="@usrText"/>
                            @foreach (var message in group.OrderBy(m => m.date))
                            {
                                <MudChatBubble>
                                    <MudMarkdown Value="@message.text"/>
                                </MudChatBubble>
                            }
                        </MudChat>
                    }
                }
            }
        </div>
        <MudSpacer/>
        <MudTextField Style="margin-top : 20px;" @ref="inputField" T="string" AutoGrow Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Send" OnAdornmentClick="OnSubmit" AdornmentAriaLabel="Submit" />
    </MudMainContent>
    
</MudLayout>

@code {
    [Parameter]
    public string? chatId {get; set;}
    private Chat? chat;
    private List<Message> messages = new();
    private MudTextField<string>? inputField;
    private HubConnection? hub;
    private List<User> users = new();
    private User? current_user;
    private bool showAddUserPanel = false;
    private bool showRenamePanel = false;
    private string addUsername = string.Empty;
    private string newChatName = string.Empty;

    private string GetUserText(String userId) {
        if (current_user is not null && userId == current_user.id) {
            return "You";
        }  else if (users is null || users.Count <= 0) {
            return "Loading...";
        }
        
        else {
            return users?.Where((x) => x.id == userId).First()?.username ?? "Loading...";
        }
    }

    private async Task OnSubmit()
    {
        if (inputField is null) return;
        if (string.IsNullOrWhiteSpace(inputField.Value)) return;
        if (hub is null || current_user is null || chatId is null) return;

        var msg = new Message {
            text = inputField.Value.Trim(),
            parentId = chatId,
            date = DateTime.Now,
            userId = current_user.id
        };

        msg = await hub.InvokeAsync<Message>(nameof(IAppHubServer.SendMessage), msg);
        messages.Add(msg);
        await inputField.Clear();
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        hub = hubService.GetHubConnection().Build();

        hub.On<Message>(nameof(IAppHubClient.ReceiveMessage), (msg) => {
            if (msg.id == chatId) {
                messages.Add(msg);
                StateHasChanged();
            }
        });

        await hub.StartAsync();
        
        messages = await hub.InvokeAsync<List<Message>>(nameof(IAppHubServer.GetMessages), chatId);
        await hub.SendAsync(nameof(IAppHubServer.ConnectToChat), chatId);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        current_user = await sessionStorage.GetItemAsync<User>("user");
        if (chat?.name is null || users is null) {
            chat = await hub!.InvokeAsync<Chat>(nameof(IAppHubServer.GetChatWithName), chatId, current_user.id);
            users = await hub!.InvokeAsync<List<User>>(nameof(IAppHubServer.GetUsers), chat.userIds);
            StateHasChanged();
        }
    }

    private void OnBack() {
        navigationManager.NavigateTo("/dash");
    }

    private async Task AddUser()
    {
        if (string.IsNullOrWhiteSpace(addUsername)) return;
        if (hub is null || chatId is null) return;

        var usr = await hub.InvokeAsync<User?>(nameof(IAppHubServer.GetUserFromUsername), addUsername.Trim());
        if (usr is null || usr.id is null) return;

        if (users.Contains(usr)) {
            addUsername = "";
            return;
        }



        var updated = await hub.InvokeAsync<Chat>(nameof(IAppHubServer.AddUserToChat), chatId, usr.id);
        chat = updated;
        if (chat?.userIds is not null)
        {
            users = await hub.InvokeAsync<List<User>>(nameof(IAppHubServer.GetUsers), chat.userIds);
        }
        addUsername = string.Empty;
        showAddUserPanel = false;
        StateHasChanged();
    }

    private async Task RenameChat()
    {
        if (string.IsNullOrWhiteSpace(newChatName)) return;
        if (hub is null || chatId is null) return;

        var updated = await hub.InvokeAsync<Chat>(nameof(IAppHubServer.SetChatName), chatId, newChatName.Trim());
        chat = updated;
        newChatName = string.Empty;
        showRenamePanel = false;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (hub is not null) {
            await hub.DisposeAsync();
        }
    }
}