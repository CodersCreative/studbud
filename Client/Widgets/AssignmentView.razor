@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using studbud.Shared.Models
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@inject NavigationManager navigationManager

<div><b>Name:</b> @assignment?.name</div>
<div><b>Due:</b> @(assignment?.due?.ToString("g") ?? "—")</div>
<MudMarkdown Value="@assignment?.text"/>

@if (!isTeacher)
{
    <MudText Typo="Typo.h6">Your Submission</MudText>
    @if (yourSubmission is null)
    {
        <div>No submission yet</div>
    }
    else
    {
        <div>@yourSubmission.text</div>
        <div class="text-muted">Submitted: @yourSubmission.date</div>
    }
}
else
{
    <MudText Typo="Typo.h6">Submissions</MudText>
    @if (submissions is null || submissions.Count == 0)
    {
        <div>No submissions</div>
    }
    else
    {
            @foreach (var s in submissions)
            {
                <MudPaper Class="pa-2 mb-2">
                    <div class="d-flex justify-space-between">
                        <div>
                            <div><b>@GetUserName(s.userId)</b></div>
                            <MudMarkdown Value="@s.text"/>
                            <div class="text-muted">@s.date</div>
                        </div>
                        <div style="min-width:160px;">
                            <div><b>Mark:</b> @(s.mark?.ToString() ?? "—") / @(assignment?.maxMark?.ToString() ?? "—")</div>
                            <div class="mt-2">
                                <MudNumericField T="int?" @bind-Value="submissionMarks[s.id ?? string.Empty]" Placeholder="Set mark" />
                                <MudButton OnClick="() => SaveMark(s)" Class="mt-1">Save</MudButton>
                            </div>
                        </div>
                    </div>
                </MudPaper>
            }
    }
}


@code {
    [Parameter]
    public string? classId { get; set; }
    [Parameter]
    public string? assignmentId { get; set; }

    private Assignment? assignment;
    private List<Submission> submissions = new();
    private HubConnection? hub;
    private Submission? yourSubmission;
    private User? current_user;
    private List<User> users = new();
    private bool isTeacher = false;
    private Dictionary<string, int?> submissionMarks = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        hub = hubService.GetHubConnection().Build();
        await hub.StartAsync();
        if (classId is null || assignmentId is null) return;

        current_user = await sessionStorage.GetItemAsync<User>("user");
        assignment = (await hub.InvokeAsync<List<Assignment>>(nameof(IAppHubServer.GetAssignments), classId)).FirstOrDefault(a => a.id == assignmentId);
        submissions = await hub.InvokeAsync<List<Submission>>(nameof(IAppHubServer.GetSubmissions), assignmentId);
        if (current_user is not null)
        {
            yourSubmission = submissions.FirstOrDefault(s => s.userId == current_user.id);
        }

        var clss = await hub.InvokeAsync<Class>(nameof(IAppHubServer.GetClass), classId);
        isTeacher = false;
        var tIds = clss?.teacherIds;
        if (tIds is not null && current_user is not null)
        {
            isTeacher = tIds.Contains(current_user.id ?? string.Empty);
        }

        if (clss?.userIds is not null)
        {
            users = await hub.InvokeAsync<List<User>>(nameof(IAppHubServer.GetUsers), clss.userIds);
        }

        // init submissionMarks dictionary
        submissionMarks = new Dictionary<string, int?>();
        foreach (var s in submissions)
        {
            var key = s.id ?? string.Empty;
            submissionMarks[key] = s.mark;
        }
    }

    private void Back() {
        navigationManager.NavigateTo($"/class/{classId}/assignments");
    }

    private string GetUserName(string? id)
    {
        return users.FirstOrDefault(u => u.id == id)?.username ?? id ?? "Unknown";
    }

    private async Task SaveMark(Submission s)
    {
        if (!isTeacher) return;
        if (hub is null) return;
        if (s.id is null) return;
        var key = s.id;
        var mark = submissionMarks.ContainsKey(key) ? submissionMarks[key] : null;
        if (mark is null) return;
        var updated = await hub.InvokeAsync<Submission>(nameof(IAppHubServer.SetSubmissionMark), s.id, (int)mark);
        if (updated is not null)
        {
            s.mark = updated.mark;
        }
    }
}
