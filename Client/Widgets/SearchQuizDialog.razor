@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using studbud.Shared.Models
@inject IDialogService Dialog

@inject ISnackbar Snackbar
@inject NavigationManager navigationManager
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@implements IAsyncDisposable

<MudDialog Style="background-color: transparent; box-shadow: none;">
   <DialogContent>
        <MudCard Style="width:400px; padding:24px; border-radius:16px;" Elevation="4">
            <MudText Typo="Typo.h5" Class="mb-4">Search Quizzes</MudText>
            <MudStack Style="overflow:scroll;" Spacing="3">
                <MudTextField @ref="searchField" T="string" AutoGrow Variant="Variant.Filled" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" OnAdornmentClick="Search" AdornmentAriaLabel="Submit" />
                @foreach (var q in quizzes) {   
                    <MudButton Variant="Variant.Outlined" Color="Color.Surface" FullWidth="true" OnClick="() => OnQuizOpened(q)">
                        <MudText Typo="Typo.h6" style="text-align: center; vertical-align: middle;">@q.name</MudText>
                        <MudMarkdown Value="@q.description"/>
                    </MudButton>
                }
            </MudStack>
        </MudCard>
   </DialogContent>
</MudDialog>

@code {
    [Parameter]
    public Action<Quiz?> OnQuizOpened {get; set;}
    private HubConnection? hub;
    MudTextField<string> searchField;
    private User current_user;
    private List<Quiz> quizzes = [];

    protected override async Task OnInitializedAsync() {
        await base.OnInitializedAsync();
        hub = hubService.GetHubConnection().Build();
        await hub.StartAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (current_user is null) {
            current_user = await sessionStorage.GetItemAsync<User>("user");
        }
    }

    private async Task Search()
    {

        if (string.IsNullOrEmpty(searchField.Value))
        {
            quizzes = [];
            return;
        }

        quizzes = await hub.InvokeAsync<List<Quiz>>(nameof(IAppHubServer.SearchQuizzes), searchField.Value);
    }

    public async ValueTask DisposeAsync()
    {
        if (hub is not null) {
            await hub.DisposeAsync();
        }
    }
}