@using studbud.Shared.Models
@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using System.Linq
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@inject NavigationManager navigationManager
@implements IAsyncDisposable
@layout MinLayout

<MudPaper Class="d-flex flex-column" Style="border-radius:16px; padding:16px;">
    <MudStack Spacing="2">
        <MudStack Row="true">
            <MudTextField Label="Flashcard Name" @bind-Value="flashcard?.name" />
            <MudSpacer />
            <MudCheckBox @bind-Value="flashcard?.published" Label="Publish" Text="Publish"/>
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Inherit" Edge="Edge.End" />
            <MudIconButton OnClick="SaveFlashcard" Icon="@Icons.Material.Filled.Save" Color="Color.Inherit" Edge="Edge.End" />
        </MudStack>
        <MudDivider/>
        <MudText Typo="Typo.h6" Style="font-weight: bold;" Class="mt-8">
            Description
        </MudText>
        <MarkdownEditor @bind-Value="flashcard.description" />
        <MudDivider/>
            <MudStack Row="true">
                
                <MudIconButton Icon="@Icons.Material.Outlined.Add" OnClick="AddDraftCard" Variant="Variant.Outlined" Color="Color.Primary" />
            </MudStack>
        <MudDivider/>
        <MudStack>
            @foreach (var card in cards) {
                <MudCard Style="border-radius:16px; padding : 10px;">
                    <MudStack Row="true">
                            <MudTextField @bind-Value="card.front" AutoGrow="true"
                                            Label="Front of Card"
                                            Variant="Variant.Filled"
                                            Style="border-radius:16px; width:100%; height : 100%;" />
                            <MudTextField @bind-Value="card.back" AutoGrow="true"
                                            Label="Back of Card"
                                            Variant="Variant.Filled"
                                            Style="border-radius:16px; width:100%; height : 100%;" />
                            <MudIconButton Icon="@Icons.Material.Outlined.Delete" OnClick="() => RemoveCard(card)" Variant="Variant.Outlined" Color="Color.Warning" />
                    </MudStack>
                </MudCard>
            }
        </MudStack>
    </MudStack>
</MudPaper>

@code {
    [Parameter]
    public required Flashcard flashcard {get; set;}
    [Parameter]
    public Action<Flashcard?> OnFlashcardChanged {get; set;} = (x) => {};
    private HubConnection? hub;
    private List<FlashcardCard> cards = new();
    private User? current_user;

    protected override async Task OnInitializedAsync()
    {
        hub = hubService.GetHubConnection().Build();
        await hub.StartAsync();

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (current_user is null) {
            current_user = await sessionStorage.GetItemAsync<User>("user");
            flashcard = await hub.InvokeAsync<Flashcard>(nameof(IAppHubServer.GetFlashcard), flashcard.id);
            cards = await hub.InvokeAsync<List<FlashcardCard>>(nameof(IAppHubServer.GetFlashcardCards), flashcard.id);

            if (cards.Count <= 0) {
                var c = new FlashcardCard { front = "", back = "",flashcardId = flashcard.id};
                cards.Add(c);
            }
                
            StateHasChanged();
            
            
        }
    } 


    private void AddDraftCard()
    {
        var c = new FlashcardCard { front = "", back = "",flashcardId = flashcard.id};
        cards.Add(c);
        StateHasChanged();
    }

    private async Task RemoveCard(FlashcardCard card)
    {
        await hub.InvokeAsync(nameof(IAppHubServer.RemoveFlashcardCard), card.id);
        cards.Remove(card);
        if (cards.Count <= 0) {
            var c = new FlashcardCard { front = "", back = "",flashcardId = flashcard.id};
            cards.Add(c);
        }
        StateHasChanged();        
    }

    private async Task SaveFlashcard()
    {
        if (hub is null) return;
        var res = await hub.InvokeAsync<Quiz>(nameof(IAppHubServer.UpdateFlashcard), flashcard);
        if (res is null) return;
        
        for (var i = 0; i < cards.Count; i++)
        {
            cards[i].flashcardId = res.id;
            var c = (cards[i].id is null) ? await hub.InvokeAsync<FlashcardCard>(nameof(IAppHubServer.CreateFlashcardCard), cards[i]) : await hub.InvokeAsync<FlashcardCard>(nameof(IAppHubServer.UpdateFlashcardCard), cards[i]);
            cards[i] = c;
        }
        OnFlashcardChanged(flashcard);
    }
    public async ValueTask DisposeAsync()
    {
        if (hub is not null) await hub.DisposeAsync();
    }
}