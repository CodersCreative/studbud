@using studbud.Shared.Models
@using Microsoft.AspNetCore.SignalR.Client
@using studbud.Client.Shared
@using System.Linq
@inject HubService hubService
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@inject NavigationManager navigationManager
@implements IAsyncDisposable
@layout MinLayout

<MudPaper Class="d-flex flex-column" Style="border-radius:16px; padding:16px;">
    <MudStack Row="true">
        <MudText Typo="Typo.h6">@(quiz?.name ?? "Loading...")</MudText>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Inherit" Edge="Edge.End" />
        <MudIconButton OnClick="SaveQuiz" Icon="@Icons.Material.Filled.Save" Color="Color.Inherit" Edge="Edge.End" />
    </MudStack>
    <MudDivider/>
    <MudTextField AutoGrow Lines="6" Label="Quiz Description" @bind-Value="quiz.description" />
    <MudStack Row="true">
        <MudIconButton Icon="@Icons.Material.Outlined.Delete" OnClick="RemoveQuestion" Variant="Variant.Outlined" Color="Color.Warning" Class="ml-auto"/>
        <MudSpacer/>
        <MudPagination Variant="Variant.Outlined" Count="@(questions.Count)" @bind-Selected="@editing"/>
        <MudSpacer/>
        <MudIconButton Icon="@Icons.Material.Outlined.Add" OnClick="AddDraftQuestion" Variant="Variant.Outlined" Color="Color.Primary" Class="ml-auto"/>
    </MudStack>
    @if (questions.Count >= editing) {
        <MudTextField AutoGrow Lines="6" Label="Question" HelperText="Enter a question" @bind-Value="questions[getEditing()].text" />
        <MudStack Row="true">
            <MudText Typo="Typo.h6">Answers</MudText>
            <MudSpacer/>
            <MudIconButton Icon="@Icons.Material.Outlined.Add" OnClick="AddQuestionAnswer" Variant="Variant.Outlined" Color="Color.Primary" Class="ml-auto"/>
        </MudStack>
        <MudStack>
            @if (questions[getEditing()].answers.Count > 0) {
                for (var i = 0; i < questions[getEditing()].answers?.Count; i++)
                {
                    <MudPaper Class="pa-2 ma-2">
                        <MudStack Row="true">
                            <MudCheckBox @bind-Value="questions[getEditing()].answers[i].isCorrect"></MudCheckBox>
                            <MudIconButton Icon="@Icons.Material.Outlined.Delete" OnClick="() => RemoveQuestionAnswer(i)" Variant="Variant.Outlined" Color="Color.Warning" Class="ml-auto"/>
                        </MudStack>
                        <MudTextField AutoGrow Lines="6" Label="Answer" @bind-Value="questions[getEditing()].answers[i].text" />    
                    </MudPaper>
                }
            }
        </MudStack>
    }
</MudPaper>

@code {
    [Parameter]
    public required Quiz quiz {get; set;}
    private HubConnection? hub;
    private List<Question> questions = new();
    private User? current_user;
    private int editing {get; set;} = 1;
    private int getEditing() {
        return editing - 1;
    }


    private void OnBack() {
        navigationManager.NavigateTo("/dash");
    }

    protected override async Task OnInitializedAsync()
    {
        hub = hubService.GetHubConnection().Build();
        await hub.StartAsync();

    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (current_user is null) {
            current_user = await sessionStorage.GetItemAsync<User>("user");
            quiz = await hub.InvokeAsync<Quiz>(nameof(IAppHubServer.GetQuiz), quiz.id);
            questions = await hub.InvokeAsync<List<Question>>(nameof(IAppHubServer.GetQuestions), quiz.id);

            if (questions.Count <= 0) {
                var q = new Question { text = "", answers = []};
                questions.Add(q);
            }
                
            StateHasChanged();
            
            
        }
    } 


    private void AddDraftQuestion()
    {
        var q = new Question { text = "", answers = []};
        questions.Add(q);
        editing += 1;
        StateHasChanged();
    }

    private void RemoveQuestionAnswer(int index)
    {
        questions[getEditing()]?.answers?.RemoveAt(index);
        StateHasChanged();
    }

    private void AddQuestionAnswer()
    {
        questions[getEditing()]?.answers?.Add(new Answer { text = "",isCorrect =false});
        StateHasChanged();
    }

    private async Task RemoveQuestion()
    {
        if (questions[getEditing()].id is not null) {
            await hub.InvokeAsync(nameof(IAppHubServer.RemoveQuestion), questions[getEditing()].id);
        }
        questions.RemoveAt(getEditing());
        if (questions.Count <= 0) {
            var q = new Question { text = "", answers = []};
            questions.Add(q);
            editing = 1;
        }
        else if (questions.Count <= editing) {
            editing -= 1;
        }
        StateHasChanged();        
    }

    private async Task SaveQuiz()
    {
        if (hub is null) return;
        var res = await hub.InvokeAsync<Quiz>(nameof(IAppHubServer.UpdateQuiz), quiz);
        if (res is null) return;
        
        for (var i = 0; i < questions.Count; i++)
        {
            questions[i].quizId = res.id;
            var que = (questions[i].id is null) ? await hub.InvokeAsync<Question>(nameof(IAppHubServer.CreateQuestion), questions[i]) : await hub.InvokeAsync<Question>(nameof(IAppHubServer.UpdateQuestion), questions[i]);
            questions[i] = que;
        }
    }
    public async ValueTask DisposeAsync()
    {
        if (hub is not null) await hub.DisposeAsync();
    }
}